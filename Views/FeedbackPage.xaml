<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="Avalia_.Views.FeedbackPage"
             x:Name="FeedbackRoot"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:sft="clr-namespace:Syncfusion.Maui.Toolkit;assembly=Syncfusion.Maui.Toolkit"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:trig="clr-namespace:Avalia_.Helpers.Triggers"
             xmlns:conv="clr-namespace:Avalia_.Helpers.Converters"
             Shell.NavBarIsVisible="False"
             Title=""
             BackgroundColor="White"
             Padding="0,12,0,12">

    <ContentPage.Resources>

        <!-- Converters -->
        <conv:SelectedToColorConverter x:Key="SelColor"
                                       SelectedColor="#FACC15"
                                       UnselectedColor="#E5E7EB" />
        <conv:SelectedToOpacityConverter x:Key="SelOpacity"
                                         SelectedOpacity="1"
                                         UnselectedOpacity="0.55" />
        <conv:SelectedEqualsConverter x:Key="SelEquals" />

        <!-- Gradientes -->
        <LinearGradientBrush x:Key="PrimaryGreenGradient"
                             StartPoint="0,0"
                             EndPoint="1,0">
            <GradientStop Color="#9EDC3E"
                          Offset="0.0" />
            <GradientStop Color="#73CC49"
                          Offset="0.5" />
            <GradientStop Color="#48BB53"
                          Offset="1.0" />
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="PrimaryBlueGradient"
                             StartPoint="0,0"
                             EndPoint="1,0">
            <GradientStop Color="#0CC2E4"
                          Offset="0.0" />
            <GradientStop Color="#1292E5"
                          Offset="0.5" />
            <GradientStop Color="#045EEA"
                          Offset="1.0" />
        </LinearGradientBrush>

        <!-- Estilos -->
        <Style TargetType="Border"
               x:Key="Card">
            <Setter Property="StrokeThickness"
                    Value="0" />
            <Setter Property="BackgroundColor"
                    Value="{DynamicResource ContentPageBackgroundColor}" />
            <Setter Property="StrokeShape">
                <Setter.Value>
                    <RoundRectangle CornerRadius="24" />
                </Setter.Value>
            </Setter>
            <Setter Property="Shadow">
                <Setter.Value>
                    <Shadow Brush="#00000033"
                            Radius="12"
                            Opacity="0.3"
                            Offset="0,6" />
                </Setter.Value>
            </Setter>
            <Setter Property="Padding"
                    Value="20" />
        </Style>

        <Style TargetType="Label"
               x:Key="H1">
            <Setter Property="FontSize"
                    Value="22" />
            <Setter Property="FontAttributes"
                    Value="Bold" />
            <Setter Property="TextColor"
                    Value="{DynamicResource TextColor}" />
        </Style>

        <Style TargetType="Button"
               x:Key="Primary">
            <Setter Property="CornerRadius"
                    Value="16" />
            <Setter Property="HeightRequest"
                    Value="54" />
            <Setter Property="FontAttributes"
                    Value="Bold" />
            <Setter Property="TextColor"
                    Value="White" />
            <Setter Property="BackgroundColor"
                    Value="#FF3B30" />
        </Style>
    </ContentPage.Resources>

    <ScrollView>
        <Grid RowDefinitions="Auto,Auto,Auto">

            <!-- Título -->
            <Label Grid.Row="0"
                   Style="{StaticResource H1}"
                   Text="Como foi o seu atendimento hoje?"
                   Margin="0,0,0,0"
                   HorizontalOptions="Center"
                   VerticalOptions="End">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Tapped="AdminTitle_Tapped" />
                </Label.GestureRecognizers>
            </Label>

            <!-- CONTEÚDO ROLÁVEL -->
            <ScrollView Grid.Row="1">
                <Grid Padding="16"
                      HorizontalOptions="Fill"
                      VerticalOptions="Fill">
                    <Border Style="{StaticResource Card}"
                            HorizontalOptions="Fill"
                            Padding="10,0,10,0"
                            MaximumWidthRequest="980">
                        <Grid x:Name="ContentHost"
                              RowSpacing="14"
                              RowDefinitions="Auto,12,Auto,8,Auto,Auto,Auto,10,Auto,Auto,Auto">

                            <!-- Quem te atendeu -->
                            <Grid Grid.Row="2"
                                  ColumnDefinitions="Auto,12,*"
                                  VerticalOptions="Start">

                                <Image WidthRequest="120"
                                       HeightRequest="120"
                                       Aspect="AspectFill"
                                       Source="{Binding SelectedAttendant.PhotoUrl}">
                                    <Image.Clip>
                                        <!-- com 120x120, centro 60/raio 60 dá círculo perfeito -->
                                        <EllipseGeometry Center="60,60"
                                                         RadiusX="60"
                                                         RadiusY="60" />
                                    </Image.Clip>
                                    <!-- opcional: placeholder quando sem seleção/foto -->
                                    <Image.Triggers>
                                        <DataTrigger TargetType="Image"
                                                     Binding="{Binding SelectedAttendant}"
                                                     Value="{x:Null}">
                                            <Setter Property="Source"
                                                    Value="avatar_placeholder.png" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Image"
                                                     Binding="{Binding SelectedAttendant.PhotoUrl}"
                                                     Value="">
                                            <Setter Property="Source"
                                                    Value="avatar_placeholder.png" />
                                        </DataTrigger>
                                    </Image.Triggers>
                                </Image>

                                <VerticalStackLayout Grid.Column="2"
                                                     Spacing="4"
                                                     VerticalOptions="Center">
                                    <Label Text="Quem te atendeu?"
                                           FontSize="14"
                                           TextColor="#6B7280"
                                           Margin="0,0,0,4" />

                                    <Border Stroke="#C5C3C3"
                                            StrokeThickness="1"
                                            StrokeShape="RoundRectangle 12"
                                            BackgroundColor="White"
                                            Padding="8,4">
                                        <Grid ColumnDefinitions="*,Auto"
                                              VerticalOptions="Center">
                                            <Picker Title="Selecione"
                                                    Visual="Default"
                                                    BackgroundColor="Transparent"
                                                    FontAttributes="Bold"
                                                    TextColor="#111827"
                                                    ItemsSource="{Binding Attendants}"
                                                    ItemDisplayBinding="{Binding Name}"
                                                    SelectedItem="{Binding SelectedAttendant}"
                                                    HorizontalOptions="FillAndExpand" />
                                            <Image Grid.Column="1"
                                                   Source="chevron.png"
                                                   WidthRequest="20"
                                                   HeightRequest="20"
                                                   Opacity="0.7"
                                                   Margin="8,0,4,0"
                                                   VerticalOptions="Center"
                                                   InputTransparent="True" />
                                        </Grid>
                                    </Border>
                                </VerticalStackLayout>
                            </Grid>
                            <!-- Avaliação do atendente -->
                            <Label Grid.Row="4"
                                   Text="{Binding SelectedAttendant.Name, StringFormat='Como você avalia o atendimento de {0}?'}"
                                   TextColor="#6B7280" />

                            <Grid Grid.Row="5"
                                  Padding="0"
                                  ColumnSpacing="2"
                                  RowSpacing="0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="100" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!-- Emojis -->
                                <Grid x:Name="gridEmoji0"
                                      Grid.Column="0"
                                      WidthRequest="78"
                                      HeightRequest="78"
                                      HorizontalOptions="Center"
                                      VerticalOptions="Center">
                                    <!-- imagem emoji0 -->
                                    <Image x:Name="imageEmoji0" Source="emoji0.png"
                                           WidthRequest="78"
                                           HeightRequest="78"
                                           Aspect="AspectFit"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />

                                    <Border x:Name="overlayEmoji0"
                                            StrokeThickness="0"
                                            StrokeShape="Ellipse">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnEmojiTapped"
                                                                  CommandParameter="0" />
                                        </Border.GestureRecognizers>
                                    </Border>
                                </Grid>

                                <Grid x:Name="gridEmoji1"
                                      Grid.Column="1"
                                      WidthRequest="78"
                                      HeightRequest="78"
                                      HorizontalOptions="Center"
                                      VerticalOptions="Center">
                                    <!-- imagem emoji1 -->
                                    <Image x:Name="imageEmoji1" Source="emoji1.png"
                                           WidthRequest="78"
                                           HeightRequest="78"
                                           Aspect="AspectFit"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />

                                    <Border x:Name="overlayEmoji1"
                                            StrokeThickness="0"
                                            StrokeShape="Ellipse">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnEmojiTapped"
                                                                  CommandParameter="1" />
                                        </Border.GestureRecognizers>
                                    </Border>
                                </Grid>

                                <Grid x:Name="gridEmoji2"
                                      Grid.Column="2"
                                      WidthRequest="78"
                                      HeightRequest="78"
                                      HorizontalOptions="Center"
                                      VerticalOptions="Center">
                                    <!-- imagem emoji2 -->
                                    <Image x:Name="imageEmoji2" Source="emoji2.png"
                                           WidthRequest="78"
                                           HeightRequest="78"
                                           Aspect="AspectFit"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />

                                    <Border x:Name="overlayEmoji2"
                                            StrokeThickness="0"
                                            StrokeShape="Ellipse">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnEmojiTapped"
                                                                  CommandParameter="2" />
                                        </Border.GestureRecognizers>
                                    </Border>
                                </Grid>

                                <Grid x:Name="gridEmoji3"
                                      Grid.Column="3"
                                      WidthRequest="78"
                                      HeightRequest="78"
                                      HorizontalOptions="Center"
                                      VerticalOptions="Center">
                                    <!-- imagem emoji3 -->
                                    <Image x:Name="imageEmoji3" Source="emoji3.png"
                                           WidthRequest="78"
                                           HeightRequest="78"
                                           Aspect="AspectFit"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />

                                    <Border x:Name="overlayEmoji3"
                                            StrokeThickness="0"
                                            StrokeShape="Ellipse">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnEmojiTapped"
                                                                  CommandParameter="3" />
                                        </Border.GestureRecognizers>
                                    </Border>
                                </Grid>

                                <Grid x:Name="gridEmoji4"
                                      Grid.Column="4"
                                      WidthRequest="78"
                                      HeightRequest="78"
                                      HorizontalOptions="Center"
                                      VerticalOptions="Center">
                                    <!-- imagem emoji4 -->
                                    <Image x:Name="imageEmoji4" Source="emoji4.png"
                                           WidthRequest="78"
                                           HeightRequest="78"
                                           Aspect="AspectFit"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />

                                    <Border x:Name="overlayEmoji4"
                                            StrokeThickness="0"
                                            StrokeShape="Ellipse">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnEmojiTapped"
                                                                  CommandParameter="4" />
                                        </Border.GestureRecognizers>
                                    </Border>
                                </Grid>

                                <!-- Legenda -->
                                <Label Grid.Row="1"
                                       Grid.Column="0"
                                       Text="Ruim"
                                       FontSize="14"
                                       TextColor="#6B7280"
                                       Margin="0,4,0,0"
                                       HorizontalTextAlignment="Center" />

                                <Label Grid.Row="1"
                                       Grid.Column="1"
                                       Text="Regular"
                                       FontSize="14"
                                       TextColor="#6B7280"
                                       Margin="0,4,0,0"
                                       HorizontalTextAlignment="Center" />

                                <Label Grid.Row="1"
                                       Grid.Column="2"
                                       Text="Bom"
                                       FontSize="14"
                                       TextColor="#6B7280"
                                       Margin="0,4,0,0"
                                       HorizontalTextAlignment="Center" />

                                <Label Grid.Row="1"
                                       Grid.Column="3"
                                       Text="Ótimo"
                                       FontSize="14"
                                       TextColor="#6B7280"
                                       Margin="0,4,0,0"
                                       HorizontalTextAlignment="Center" />

                                <Label Grid.Row="1"
                                       Grid.Column="4"
                                       Text="Excelente"
                                       FontSize="14"
                                       TextColor="#6B7280"
                                       Margin="0,4,0,0"
                                       HorizontalTextAlignment="Center" />
                            </Grid>



                            <Label Grid.Row="8"
                                   Text="E como você avalia a nossa instituição?"
                                   TextColor="#6B7280" />

                            <toolkit:RatingView Grid.Row="9"
                                                MaximumRating="5"
                                                Rating="{Binding InstitutionScore, Mode=TwoWay}"
                                                ShapeDiameter="55"
                                                FillColor="#FACC15"
                                                IsReadOnly="False"
                                                HorizontalOptions="Center" />

                            <!-- Comentário -->
                            <VerticalStackLayout Grid.Row="10"
                                                 Margin="0,25,0,0"
                                                 Spacing="8">
                                <Label Text="Quer deixar algum comentário?"
                                       TextColor="#6B7280" />
                                <Border Stroke="#C5C3C3"
                                        StrokeThickness="1"
                                        StrokeShape="RoundRectangle 12"
                                        BackgroundColor="White"
                                        Padding="8,6">
                                    <Editor x:Name="CommentEditor"
                                            Placeholder="Escreva aqui..."
                                            MaxLength="250"
                                            AutoSize="Disabled"
                                            Text="{Binding Comment}"
                                            HeightRequest="180"
                                            MinimumHeightRequest="180"
                                            />
                                </Border>
                            </VerticalStackLayout>
                        </Grid>
                    </Border>
                </Grid>
            </ScrollView>

            <!-- Botão fixo no rodapé -->
            <Grid Grid.Row="2"
                  x:Name="ButtonHost"
                  Padding="20,0,20,0"
                  HorizontalOptions="Fill">
                <Border x:Name="ConfirmButton"
                        Background="{StaticResource PrimaryGreenGradient}"
                        StrokeThickness="0"
                        StrokeShape="RoundRectangle 24"
                        HeightRequest="54"
                        HorizontalOptions="Fill"
                        Padding="0">
                    <Border.Shadow>
                        <Shadow Brush="#40000000"
                                Offset="0,8"
                                Radius="12" />
                    </Border.Shadow>

                    <Grid x:Name="BtnContent"
                          HorizontalOptions="Fill">
                        <Label x:Name="BtnText"
                               Text="Confirmar"
                               TextColor="White"
                               FontAttributes="Bold"
                               FontSize="16"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />

                        <!-- spinner no centro enquanto envia, sem animação/morph -->
                        <ActivityIndicator x:Name="BtnSpinner"
                                           Color="White"
                                           IsVisible="{Binding IsSubmitting}"
                                           IsRunning="{Binding IsSubmitting}"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />
                    </Grid>

                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ConfirmCommand}" />
                    </Border.GestureRecognizers>
                </Border>
            </Grid>
        </Grid>
    </ScrollView>
</ContentPage>
